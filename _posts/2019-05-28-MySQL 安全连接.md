# MySQL 安全连接
## 客户端
MySQL 客户端有一个参数 `--ssl-mode=mode` 来标示从客户端到服务端的连接的安全状态。***mode*** 可选参数值如下

* ***PREFERRED***：此参数默认值，如果服务端支持加密那么采用加密连接，如果不支持，那么就采用普通的未加密连接。
* ***REQUIRED***：如果服务端支持加密那么采用加密连接，如果不支持，那么就提示连接失败。
* ***VERIFY_CA***：和 REQUIRED 的行为类似，唯一额外多了一步就是校验服务端 CA 证书的和客户端配置的 CA 证书是否一致，如果不一致就失败。
* ***VERIFY_IDENTIFY***：和 VERIFY_CA 的行为类似，唯一额外多了一步就是校验服务端发送给客户端的证书中包含的主机名和客户端指定连接的主机名是否一致，如果不一致就失败。
* ***DISABLED***：采用非加密连接

如果你在发起连接的时候没有指定 `--ssl-mode` 参数，但是指定了 `--ssl-ca` 或者 `--ssl-capath` 参数其实就相当于传了 `--ssl-mode=VERIFY_CA` 参数；

但是如果你发起连接的时候指定了 `--ssl-mode` 参数的值为 ***VERIFY_CA*** 或者 ***VERIFY_IDENTIFY***，那么需要同时指定 `--ssl-ca` 或者 `--ssl-capath` 参数

## 服务端
如果你希望配置某个数据库账号必须以加密连接的方式进行交互，那么在 `CREATE USER` 的时候需要指定 ***REQUIRE*** 字段，当然也可以事后通过 `ALTER USER` 来修改。我们来介绍下 ***REQUIRE*** 字段与安全相关的 ***tls_option*** 值

* ***NONE***：代表只要客户端使用当前的数据库账号，密码验证通过后，就可以通过非加密连接的方式访问数据库；当然如果客户端指定通过加密方式连接，只要客户端指定的。
* ***SSL***：代表只要客户端使用当前的数据库账号，就必须通过加密连接的方式访问数据库。
* ***X509***：代表只要客户端使用当前的数据库账号，就必须通过加密连接的方式访问数据库，需要客户端提供一个有效的证书。同时客户端必须指定 `--ssl-key` 和 `--ssl-cert` 两个参数，建议同时带上 `--ssl-ca ` 参数。
* ***ISSUER 'issuer'***：代表只要客户端使用当前的数据库账号，就必须通过加密连接的方式访问数据库，需要客户端提供一个有效的证书，并且发行方和创建账号时候指定的 ***issue***一致。同时客户端必须指定 `--ssl-key` 和 `--ssl-cert` 两个参数，建议同时带上 `--ssl-ca ` 参数。
* ***SUBJECT 'subject'***：代表只要客户端使用当前的数据库账号，就必须通过加密连接的方式访问数据库，需要客户端提供一个有效的证书，并且主体和创建账号时候指定的 ***subject***一致。同时客户端必须指定 `--ssl-key` 和 `--ssl-cert` 两个参数，建议同时带上 `--ssl-ca ` 参数。
* ***CIPHER 'cipher'***：代表只要客户端使用当前的数据库账号，就必须通过加密暗号指定的加密方式访问数据库。

在云上我们一般都采用 ***SSL***，可以满足大部分场景了。

## 客户端和服务端配置区别
通过上面的介绍，其实我们已经发现，通过客户端的参数或者服务端的参数都能实现数据库的加密连接。可能有人会问，那么我到底是要选择服务端还是客户端进行参数配置呢，我的建议是

* 优先是服务端的参数配置，针对特定的数据库账号进行加密连接等级设置，避免用户在连接的时候忘记主动加上加密连接的参数了。
* 客户端的参数配置，一般是针对数据库的数据不是很敏感的情况下，客户端自行决定是否要加密连接。 

# 参考资料
* https://dev.mysql.com/doc/mysql-security-excerpt/5.7/en/encrypted-connection-options.html#option_general_ssl-mode
* https://dev.mysql.com/doc/refman/5.7/en/alter-user.html
* https://dev.mysql.com/doc/mysql-security-excerpt/5.7/en/using-encrypted-connections.html